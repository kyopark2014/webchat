# webchat
It is a salable chat service based on socket.io and PUBSUB.

There are three repositories related to this project.

chat server: https://github.com/kyopark2014/webchat-golang-chat

profile server: https://github.com/kyopark2014/webchat-golang-profile

web client: https://github.com/kyopark2014/webchat-js-webclient


### OVERALL STRUCTURE

There are two connection ways between client and server. Socket.io is used for chat session and REST API is used for call logs.

![image](https://user-images.githubusercontent.com/52392004/82965685-c6455500-a003-11ea-91ed-974b845d856d.png)

where REDIS is for PUBSUB and DYNAMO DB is for storage for call logs. Notice that the diagram shows the simple flow for messaging where many flows are ignored to explain the basic flows.


### Basic Call Flow

Client <-> Server : Socket.io

### Groupchat

#### Create

As shown in the bellow picture, A will make a groupchat using a create event. Then IM server will save the participant list and subscribe the groupchat toward PUBSUB server. In this project, I will use a redis server for PUBSUB operation.
The last participants execept owner will have an event which notices that "SUBSCRIBE" is required to get groupchat messages. After all of subscribe request were completed, the members in the groupchat can share messages easily based on PUBSUB.

This picture shows what relationship of client, IM and REDIS.
![image](https://user-images.githubusercontent.com/52392004/84559883-ac34a200-ad79-11ea-8f8b-8562cf91cc5e.png)

The basic groupchat flow is shown as bellow.
![alternative text](http://www.plantuml.com/plantuml/png/fPH1Jzj048NlyokUt0D5GDN0BL8gOfEsaQY42AZdpNg8LooxONUTDAtwtpkE8pSGGf5wiV7iDxFllK4vZqc5L3zOQ6NjdVLBYlV6pLLG3z1MnOXV102vqlUpu6jN5jxwWE-LIRm-6ORWbsqnjqArk0ybX-VLOKh1JEl4O-tTnFnaVAJVTF3tnfXMbX65qeqesZxXm3wjvboyAEL5TFnsTFHsTFWlr1h73GWVKkM93f99bf7bAXgDpn8oUYV9d_Jm_kesdzpcXuSPLQPat7cVflu7aJoG5TQmIndUNPfPbN9RCocTVC1myyutxuBObLWtaaX8HfkvSWdZRxrdtwVFli-aerH9JLLaNEGWUgovPhIwY0O338-H7wF0aWD3zkPO9vRRLeXUttFwO3m48t8-CVo26trV99xv-AAF6JiEQjEWruReQal2fOcfZyYscrf73ci_pJoY8Ku-DKRGbq2kHyER4MQzJ6HBJOuQqTAl5enjPrR6TaXhHZ1vJehhSJv29ZEs5Gj9DnM35o9GrX2mh8oka7Kj6Kn4uCVQ12uRefsnDDO-DPbaZ5XORBdOLI9_N8udNv4ZY_Kqwc2c_7Iw30UrV9l0AVhxuJRkZ0JRX79qr8VrgjoD9N2gWzkjDxsTnlwMzKRBVWl5hgez3ivUSo1N2F4VuizU4pyOj1dfIYL4Zj5urovKbIj0Zf_yept4MRRNSBFt5jdTZrIx9UHTOJS5ANT-YwvmpgviVlQ8_W00)



RESTART

If one groupchat is not activate any more, it should be desubscribed in order to reduce resources.
So, after the groupchat was deactivated, it can be activate when one of participants wants to send a message.
But since there is no session based on PUBSUB machanism, it may not activate again.
This picture shows how it reactivate.

![alternative text](http://www.plantuml.com/plantuml/png/fPJDRjf04CVlynGZNz8eGYfmur35TbBLLJ-gegZdPJt0Aek7x8v3qwhltZ6ca6AieeO3nhC__pz65jTHJ91wvT4Qx-UUDn3lNRKsmQpGUXCZ_WJKJsRi_I9mNPKvUmxuRUc4jYTf2BnfXvbNgiKvb1IEfwb8SBDQgB1SJTqFmjVm2ouEZb6UF65KoZQXuFa91M9vMbD-Cif9j3WVlJqVJV-5UbTH0o87MJB0XJZHMabcehFuLfUCmu7mO8YlljnbqxliyZA1fIi9vymou-y0nWe7J7VNR7VD0InxJrOSLn6BZyEZ-z7H_HYWD69c9XBUP0ZmK5DDsBe2G8g3DuqCJZ1PnKM2PguriIGngl5e6Xq01GvSnQWjnLctDfLeroZ8SqmMmsHFgjNLrGGzcx83Go2fGtLAP_zyskG9j7qtKONnhwJlFnUVjdwuSRBiLsdfLYJGeH0-pwc0UQHkfMPb9N9ricow4zWjKaNqUvf_BRBRRR3EiVxuK4pVOOP9h6VH1ZSZ3FHGkw0kSmvjovPliuzmqWy7hjV5JUCpEdFVtRa-UyYeNeSAJOFU2datLK-3SN-3hOKIBmW__f_mYPwsRtfdr-tqprQo_QJJIAVxxFb-S4rLsVnZ0Vm6)

OFFLINE -> ONLINE

![alternative text](http://www.plantuml.com/plantuml/png/ZPD1RzD048NlyokclhHH5OcKMmzLlIaLHj0YXGfntAmdoIgR7RCx9WJ4VyUE5uSwaThJPD_xPkP58zz6qK7gZKEZdLiuta9SMr_fe3Ted8uHVmCYej9clGnS-tBAZWD-NLcXlPE7mDjELAwXEfn3IM6evYB1pckXmh2VsL-4R-0Fd1ysHjavmjXGfWq5_piKY6LNqVHqb5DeyNhqtUlH_2NKMKyjY1nanG3dOiKHPaf7Q_3UyHOdO-7n12y-FwdPangDCbZPad31B7F-2Q2DSC0yLPNg5C2mSsJ4iezOV9eCtbU3zrk0KekUwqXufn3WUqqrORSL078StxHZyEmChv4NYpOwWEhagqRBDd6PDRa2Pij91j2glMbMPDQOGo_VgKQDme6wniE6bcRloGXUf3tZ6_Pj7G4qG6g_lEpdxkUKkA4OzP8Y198w-9I85obGQitnUkZa_tJFMEaWrjXAUq5demoeBk27n-9Xh-9H8iUwF1wI8XqPpr8zF7ufxh-TOFfyTLLgePD4doqhoTaV57RzNqvNRBpcnyTYzXxLCohP_R5wxt15DP1loPVjPmVm5m00)


REFER

![alternative text](http://www.plantuml.com/plantuml/png/ZPH1Jzj048NlyokUVA48HMeW9nyeMJkehbgeagAgnuqzILPil65t3QLL_tkzSS2EIGkdqRpv_6PsHlA5yzBwQgsHIwqNsZoGkrNbHbgvHgwbS_XD021aVhkqfYgBn6XZyNsbF6yhOslDGoCANLCDRcp1jg-ElRTgNddESbFEr2_6U_f3Hsr7vnyrmzLK7eQYReKj6_-uuUJmA8VGxEtevEte-3LKgv8326FzoX0TUUKr8nBIgHoNzP8n77Wp6EBTrninkn77nn6jLC5O6EFdvYUHpBsn6E-YsCLa5rEYt6ZDkLUcTCY-37lvQIy_w-KZea9wEPUEaGeGtLLSCPffY6YCmNcmHOpfv78o3Hthj5O3Vd8I8tD88N4ljIfGEROVoBAlRDb8ptXZ6OVuEPjzX43qwJgxGXfHKsewdI9k2tKQLD7Ln9CYYmBfF-sJm_Pd-_PdGKswMj8ehzb7hfgxtAevm_9TfImNM1YBvN2_toZ-Bre3NVTP7PDf9YQ8EjLKX3rh8mjifFKgLnjPUcZb_6xLB_NdRyFRhgw_PPS_O1QGMczlv2AYT5kFuUGzDnzrhnsjtJBglpw8lNCrOdkgftn_wotLRlmbDcgnqU0yRQ4BBelm5o3w2m00)


DEPART 

![alternative text](http://www.plantuml.com/plantuml/png/ZPB1RXCn48RlynIZlPIgYiGsDmwewsqGAm6g6YBEZdUQM7KymPub5CIxO-CLT9SYcelZx__oprZALHGTP3WuDDgvEySdYFVM7tNG1pHEnuZV0TD7QNE_2ppulcN70J_jhT2lf0c1JmKgbwoYS-Wfp6aZ4kns4EeC-xNzHlWIVi3PdubH7XnXJ9R9Iy7ZX0AnF1ofVNAL9zNk-Uhg-MhpFzLPJrb43h9dW3EnuWWhfQCr-CRn2Uk5yAB65pSRjTwey_CAzhOdl6EMBNy5q4PISJEUQZnR0CFEaH7BFcBtlfxTBsVt9K2lHMzr9BnM2F1ve86mJ0M01XUlSms-mklLJNFx4QjTNOsyITGuZZJ2v6MSUYukKkHOzvWUBDROe_Q2paQ1G384_pSVVpqE2tJWBvGcM5_Ytzqf78wz5lftHTa-YUdBksxz5dSrLZrb7viAIbncNIRhKPH0vcfALM6JnqvQblEMPURjbBQ5JLlc6sy-f7FTtdPgDHfNvFlyJmVu2G00)

 
#### Overall
![alternative text](http://www.plantuml.com/plantuml/png/ZP51Rzf048Nlyoj6N0AAKj4SUuYo1fIuQGB2H56Fote2AnOltHsdfLN_UyVOZN6Ar711lFVDlfd7TMGTkDmwY1jRx7JGMpHEnuY_0EMJQBDP1LyM-SWx7_1fRPaEZWh1Vw_5n0bLupxa5DwgYZdOPScK6bzazYVX47x3MPiOUUy8er2ckuje5CZpVaUZawkSHDFtevFte-f_gBC5LI3wm6iFSCQM7M4lBInRpTONFLZRdF3PUrxw7m3Qi0-ecky4m7Zdo5Hen2TQgjskgwNt7z_yleHSirxgI3YM1xwLL1BE9-CqGvNXV0n7_jS7TJy5K7XnSTKyZv_mTh6OuSraWNtdLxOO83IMGED40BCciy4NxMnkUG-Y7OzFx-1rG7GbqkLmEBr3-2UfZfezIbH6ZBFWdwqZL8CsKJOMi797Md9Rezc-ClKBjRDrobNLZ7Z65mKPndxqPaFymVe1YDC-_9XaetcQJAh1mns70mDf9hbJS_1-2z2zyEPuL-nNHmoWk_BvUSsrQmNYCXJjtF50KdU4KbB_SpPz660JAN-dMBrjNFKw9u0OdGuYyLzigSsct3LCSwTqd7n9irjKDGKWwcj9ZTJqeaucNbEHbrlt1m00)

#### Online
![alternative text](http://www.plantuml.com/plantuml/png/ZPF1RXen48RlynGZBcaEI8LZ3rNMGDMLcZPYXQeUZNSIh1WFjMTBQTLthxUBHHojL3Y0_Czd_zySk8kYWtHxXqOxz-Zu2F7P-eCEUe_6wHZnDs3wA6sUdm9tlbsmuu1VTrRetwGAWOz3g5oY1fn3I-5rMea4k-s4QiE-iRy8ty8VkBaqHZavIj_1cbuANaue4ClfG8jHbL6qlXvTNOzM_qETzTI3o45s370ZLXpXHEbe3NvmVCJPL7WwmpSF6zLirEtj17Qs9NnabYt_1D16E61r_bK0XfqZ8vPznFf-zkey1_ZUKKUuNYth1gi6rqk0LelUwaYu_FQvkly2KE7qVNyRtw5Xxya8zASKhfSfIoRDObshLIe6DR3pWfsFiAfuTxAFJnCKHfMV7ihJA0e76W0eUXyswbFTV4ILXodDvJawTwjBebumBJdxWy9f08lMD2AXivVsRTQuNCbtIfcgGBBHh6pBQrJZSIbHbggyJY3TZkvauy7faPNo1WKmwf-1KZ_7XNsHZijVY3loRV_t1FWB)

#### Offline

![alternative text](http://www.plantuml.com/plantuml/png/ZPB1Rjim38RlV0esbww704kFFHIraWmpi6v3Z6BOKP6PHAWYTXBTBXlsxgDd0JQA0eik0icF_7yAkijYatJ7WCw6i0ly0ldHnoURx15Ti3dZRq0znhh7VU8kjaiEdF3RmGlzgrGfySkGD46f0UVKKdgThKIIttP2jUFO-5-4x-4FN8wAMKw1C2lbUbCmhL0YbjCJBT-syXPQdu-kpqUh_w71H-f1v2G71hWKBu5mPcps3Z_e8-DYBZnVuBkl3wPvC5TNCpZubd37B5l-2M2TwE2gt0R0SGZan7FCMDylNiNN03ywwWWtwrNTODNWPWNGMh5RcmbNtpzNzry0AfpVzjruWuvZr7xGI9EAQqwTDCjDRTOg36PWh_7YOgId4sR7l9-XC9eofCXeAGid6W2OAFIJTE5FTVCHJIaN8QDTlDlrBpU_vTZV4miJ0ngEKZUOIFyAFTCWsUAHShPxxHs0SK1HA-rcp9W9qrBmpvHE1Pokf2MIiXC2m1t5jl-X07y1)

Once one of client in a chatroom is not online, PUBSUB is not a good way to commnicate messages. So, the application server saves the message in Queue too using linked list. Then, once a client is back online, the message can be delivered to the client robustly.

The proposed architecture is using PUBSUB to endpoints which doesn't have the redundancy and some of benefits to notice the received message and manages a single connection for multiple chat rooms. Notice that see https://github.com/kyopark2014/webchat-golang-chat if you need more.
Sender will publish to Receiver directly and messages can be delivered consistently without the state of Receiver.

jTb6Lr1I9QAo_Cm0BBxqYB1XtKk2di6HS7djplCI3hpUilM67XmNSoOvmROnVcHy0NFXWN8rVDdvh066K8k6bqGwRBykjyydMkGJekEShxWZRRrS0ZptrXCEjMBLuVGvGuV67w8MdA8pMGGtX5C0e2Q0oWaT3h4Oyg08S7Dhwkc4N0GSsU9ma7YUZnniB5k6C1GEe1uioiIZVMzGHpbZK06aNIzmJ5l6bDirv0R2OQnqTdMBZa27N7TPeT7opZmWBIxwtUWGWNtZsJ0bXhLTD-pcu5gvVEM7bYj3IOoyjTRWs5YTT8dFyYSQ9NXi8sBJBdJwvRKxnqd4iV4aUBr_l6PiM6swz57B3jKSbdNzLiTFCC5kutXrqQbNkrwhyUwlotrjDgZhNAltBAHxSRO7Ux7ZdUJmg3eoLj_zNXv2-uUJ6PiAqOSoFsHjrHqe-aNs9d6530mz7cobKIgnU8ooJsTIZIWIGFi-Kg9uJJSlBZ-V_tNpWr2OV6EV4xsRPr01dfBluAm7m1m00)

